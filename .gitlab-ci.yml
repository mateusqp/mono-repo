stages:
  - build
  - test
  - package
  - push
  - update-config-repo

variables:
  HARBOR_REGISTRY: "registry.nuvem.unicamp.br/project/app"
  IMAGE_TAG: "${CI_COMMIT_SHA}"
  MAVEN_CLI_OPTS: "--batch-mode --errors --fail-at-end -Dmaven.repo.local=.m2/repository"
  CONFIG_REPO_PATH: "/tmp/config-repo"

backend:build:
  stage: build
  image: maven:3-eclipse-temurin-21
  cache:
    key: "maven-${CI_PROJECT_NAME}"
    paths:
      - .m2/repository
    policy: pull-push
  script:
    - mvn $MAVEN_CLI_OPTS -f apps/backend/pom.xml clean compile

backend:test:
  stage: test
  image: maven:3-eclipse-temurin-21
  cache:
    key: "maven-${CI_PROJECT_NAME}"
    paths:
      - .m2/repository
    policy: pull-push
  needs:
    - backend:build
  script:
    - mvn $MAVEN_CLI_OPTS -f apps/backend/pom.xml test

backend:package:
  stage: package
  image: maven:3-eclipse-temurin-21
  cache:
    key: "maven-${CI_PROJECT_NAME}"
    paths:
      - .m2/repository
    policy: pull-push
  needs:
    - backend:test
  script:
    - mvn $MAVEN_CLI_OPTS -f apps/backend/pom.xml package -DskipTests
  artifacts:
    expire_in: 1 week
    paths:
      - apps/backend/target/*.jar

frontend:build:
  stage: build
  image: node:20
  cache:
    key: "frontend-${CI_PROJECT_NAME}"
    paths:
      - apps/frontend/node_modules/
    policy: pull-push
  script:
    - cd apps/frontend
    - npm ci

frontend:test:
  stage: test
  image: node:20
  cache:
    key: "frontend-${CI_PROJECT_NAME}"
    paths:
      - apps/frontend/node_modules/
    policy: pull-push
  needs:
    - frontend:build
  script:
    - cd apps/frontend
    - npm test -- --ci --watch=false

frontend:package:dev:
  stage: package
  image: node:20
  cache:
    key: "frontend-${CI_PROJECT_NAME}"
    paths:
      - apps/frontend/node_modules/
    policy: pull-push
  needs:
    - frontend:test
  script:
    - cd apps/frontend
    - cp .env.dev .env
    - npm run build
  artifacts:
    expire_in: 1 week
    paths:
      - apps/frontend/dist
  only:
    - develop

frontend:package:hom:
  stage: package
  image: node:20
  cache:
    key: "frontend-${CI_PROJECT_NAME}"
    paths:
      - apps/frontend/node_modules/
    policy: pull-push
  needs:
    - frontend:test
  script:
    - cd apps/frontend
    - cp .env.hom .env
    - npm run build
  artifacts:
    expire_in: 1 week
    paths:
      - apps/frontend/dist
  only:
    - hom

frontend:package:prod:
  stage: package
  image: node:20
  cache:
    key: "frontend-${CI_PROJECT_NAME}"
    paths:
      - apps/frontend/node_modules/
    policy: pull-push
  needs:
    - frontend:test
  script:
    - cd apps/frontend
    - cp .env.prod .env
    - npm run build
  artifacts:
    expire_in: 1 week
    paths:
      - apps/frontend/dist
  only:
    - main

build-and-push-images:dev:
  stage: push
  environment: dev
  image:
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: [""]
  needs:
    - job: backend:package
      artifacts: true
    - job: frontend:package:dev
      artifacts: true
  script:
    - mkdir -p /kaniko/.docker
    - echo '{"auths":{"'${HARBOR_REGISTRY}'":{"username":"'${HARBOR_USER}'","password":"'${HARBOR_PASSWORD}'"}}}' > /kaniko/.docker/config.json
    - /kaniko/executor --context ${CI_PROJECT_DIR}/apps/backend --dockerfile ${CI_PROJECT_DIR}/apps/backend/Dockerfile --destination ${HARBOR_REGISTRY}/app-backend:${IMAGE_TAG}
    - /kaniko/executor --context ${CI_PROJECT_DIR}/apps/frontend --dockerfile ${CI_PROJECT_DIR}/apps/frontend/Dockerfile --destination ${HARBOR_REGISTRY}/app-frontend:${IMAGE_TAG}
  only:
    - develop

build-and-push-images:hom:
  stage: push
  environment: hom
  image:
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: [""]
  needs:
    - job: backend:package
      artifacts: true
    - job: frontend:package:hom
      artifacts: true
  script:
    - mkdir -p /kaniko/.docker
    - echo '{"auths":{"'${HARBOR_REGISTRY}'":{"username":"'${HARBOR_USER}'","password":"'${HARBOR_PASSWORD}'"}}}' > /kaniko/.docker/config.json
    - /kaniko/executor --context ${CI_PROJECT_DIR}/apps/backend --dockerfile ${CI_PROJECT_DIR}/apps/backend/Dockerfile --destination ${HARBOR_REGISTRY}/app-backend:${IMAGE_TAG}
    - /kaniko/executor --context ${CI_PROJECT_DIR}/apps/frontend --dockerfile ${CI_PROJECT_DIR}/apps/frontend/Dockerfile --destination ${HARBOR_REGISTRY}/app-frontend:${IMAGE_TAG}
  only:
    - hom

build-and-push-images:prod:
  stage: push
  environment: prod
  image:
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: [""]
  needs:
    - job: backend:package
      artifacts: true
    - job: frontend:package:prod
      artifacts: true
  script:
    - mkdir -p /kaniko/.docker
    - echo '{"auths":{"'${HARBOR_REGISTRY}'":{"username":"'${HARBOR_USER}'","password":"'${HARBOR_PASSWORD}'"}}}' > /kaniko/.docker/config.json
    - /kaniko/executor --context ${CI_PROJECT_DIR}/apps/backend --dockerfile ${CI_PROJECT_DIR}/apps/backend/Dockerfile --destination ${HARBOR_REGISTRY}/app-backend:${IMAGE_TAG}
    - /kaniko/executor --context ${CI_PROJECT_DIR}/apps/frontend --dockerfile ${CI_PROJECT_DIR}/apps/frontend/Dockerfile --destination ${HARBOR_REGISTRY}/app-frontend:${IMAGE_TAG}
  only:
    - main

update-config-repo:dev:
  stage: update-config-repo
  environment: dev
  image: alpine:latest
  variables:
    GIT_STRATEGY: none
  needs:
    - build-and-push-images:dev
  before_script:
    - apk add --no-cache git yq
  script:
    - '[ -n "$CONFIG_REPO_URL" ] || (echo "CONFIG_REPO_URL must be set" >&2; exit 1)'
    - if [ -d "$CONFIG_REPO_PATH" ]; then rm -rf $CONFIG_REPO_PATH; fi
    - git clone "$CONFIG_REPO_URL" $CONFIG_REPO_PATH
    - cd $CONFIG_REPO_PATH
    - git checkout main
    - yq eval '.app-backend.image.tag = "'$IMAGE_TAG'"' -i app/values-dev.yaml
    - yq eval '.app-frontend.image.tag = "'$IMAGE_TAG'"' -i app/values-dev.yaml
    - git config user.name "ci-bot"
    - git config user.email "ci-bot@example.com"
    - git add app/values-dev.yaml
    - git commit -m "chore: update dev images to ${IMAGE_TAG}"
    - git push "$CONFIG_REPO_URL"
  only:
    - develop

update-config-repo:hom:
  stage: update-config-repo
  environment: hom
  image: alpine:latest
  variables:
    GIT_STRATEGY: none
  needs:
    - build-and-push-images:hom
  before_script:
    - apk add --no-cache git yq
  script:
    - '[ -n "$CONFIG_REPO_URL" ] || (echo "CONFIG_REPO_URL must be set" >&2; exit 1)'
    - if [ -d "$CONFIG_REPO_PATH" ]; then rm -rf $CONFIG_REPO_PATH; fi
    - git clone "$CONFIG_REPO_URL" $CONFIG_REPO_PATH
    - cd $CONFIG_REPO_PATH
    - git checkout main
    - yq eval '.app-backend.image.tag = "'$IMAGE_TAG'"' -i app/values-homolog.yaml
    - yq eval '.app-frontend.image.tag = "'$IMAGE_TAG'"' -i app/values-homolog.yaml
    - git config user.name "ci-bot"
    - git config user.email "ci-bot@example.com"
    - git add app/values-homolog.yaml
    - git commit -m "chore: update hom images to ${IMAGE_TAG}"
    - git push "$CONFIG_REPO_URL"
  only:
    - hom

update-config-repo:prod:
  stage: update-config-repo
  environment: prod
  image: alpine:latest
  variables:
    GIT_STRATEGY: none
  needs:
    - build-and-push-images:prod
  before_script:
    - apk add --no-cache git yq
  script:
    - '[ -n "$CONFIG_REPO_URL" ] || (echo "CONFIG_REPO_URL must be set" >&2; exit 1)'
    - if [ -d "$CONFIG_REPO_PATH" ]; then rm -rf $CONFIG_REPO_PATH; fi
    - git clone "$CONFIG_REPO_URL" $CONFIG_REPO_PATH
    - cd $CONFIG_REPO_PATH
    - git checkout main
    - yq eval '.app-backend.image.tag = "'$IMAGE_TAG'"' -i app/values-prod.yaml
    - yq eval '.app-frontend.image.tag = "'$IMAGE_TAG'"' -i app/values-prod.yaml
    - git config user.name "ci-bot"
    - git config user.email "ci-bot@example.com"
    - git add app/values-prod.yaml
    - git commit -m "chore: update prod images to ${IMAGE_TAG}"
    - git push "$CONFIG_REPO_URL"
  only:
    - main
